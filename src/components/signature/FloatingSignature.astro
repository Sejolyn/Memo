---
// 签名组件 - 参考 Arthals-Ink 实现
import type { HTMLAttributes } from 'astro/types'

interface Props extends HTMLAttributes<'div'> {
  mode?: 'loop' | 'once'
  drawDelay?: number
  rollbackDelay?: number
  loopPause?: number
  defaultDuration?: number
}

const {
  mode = 'loop',
  drawDelay = 150,
  rollbackDelay = 100,
  loopPause = 3000,
  defaultDuration = 2000, // 增加默认时长以适应填充动画
  class: className,
  ...rest
} = Astro.props
---

<div 
  class:list={['signature-wrapper', className]} 
  data-mode={mode}
  {...rest}
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="396.61498061007853"
    height="200"
    viewBox="0 11.039999961853027 102.4800033569336 46.71999740600586"
    class="signature-svg"
  >
    <!-- 使用 stroke 和 fill 配合实现 描边->填充 效果 -->
    <path
      data-seq="1"
      d="M13 36.04L13 36.04Q12.04 34.76 10.52 32.48L10.52 32.48Q0 31.44 0 28.08L0 28.08Q0 27.32 0.78 26.84Q1.56 26.36 3.16 26.36L3.16 26.36Q7.16 26.36 11.12 31.44L11.12 31.44Q15.12 31.84 20.20 31.84L20.20 31.84L20.64 31.84Q25.76 28.76 30.16 25.64L30.16 25.64Q31.96 22.36 33.28 20.22Q34.60 18.08 36.48 15.76L36.48 15.76Q40.20 11.04 44.32 11.04L44.32 11.04Q45.40 11.04 45.40 12L45.40 12Q45.40 14.32 41.56 18.08Q37.72 21.84 31.36 26.16L31.36 26.16Q29.44 29.84 28.48 31.52L28.48 31.52Q34.08 31.08 36.56 30.16L36.56 30.16L36.68 30.16Q36.84 30.16 36.84 30.38Q36.84 30.60 36.56 31L36.56 31Q33.56 31.92 27.92 32.44L27.92 32.44Q25.76 36.16 23.74 38.22Q21.72 40.28 19.68 40.28L19.68 40.28Q16.40 40.28 13.48 36.64L13.48 36.64Q7.76 39.52 3.36 41.04L3.36 41.04Q2.76 41.24 1.98 41.24Q1.20 41.24 1.20 40.64L1.20 40.64Q1.20 40.32 1.52 40.06Q1.84 39.80 2.36 39.80L2.36 39.80Q5.56 39.80 13 36.04ZM20.64 32.84L20.64 32.84Q17.60 34.56 14.64 36.08L14.64 36.08Q17.32 39.40 19.52 39.40L19.52 39.40Q21.16 39.40 22.78 37.64Q24.40 35.88 26.36 32.56L26.36 32.56Q23.92 32.76 20.64 32.84ZM43.20 12L43.20 12Q40.44 12 37.64 15.68L37.64 15.68Q35.32 18.80 32.56 23.92L32.56 23.92Q37.60 20.20 40.64 17.14Q43.68 14.08 43.68 12.40L43.68 12.40Q43.68 12 43.20 12ZM1.92 27.92L1.92 27.92Q1.92 30.20 9.64 31.24L9.64 31.24Q6.52 27.08 3.36 27.08L3.36 27.08Q1.92 27.08 1.92 27.92ZM14.16 35.48L14.16 35.48Q16.64 34.16 18.92 32.84L18.92 32.84L18.76 32.84Q15.28 32.84 12.04 32.60L12.04 32.60Q13.56 34.72 14.16 35.48ZM29.08 27.68L29.08 27.68Q26.92 29.12 22.36 31.84L22.36 31.84Q25.44 31.76 26.88 31.64L26.88 31.64Q27.64 30.32 29.08 27.68ZM45.40 34.20L46.40 33.36Q46.68 33.16 46.92 33.16Q47.16 33.16 47.16 33.44L47.16 33.44L47.16 33.52Q43 36.96 40.24 38.68Q37.48 40.40 35.24 40.40L35.24 40.40Q33.44 40.40 33.44 38.64L33.44 38.64Q33.44 36.04 36.08 33.30Q38.72 30.56 40.52 30.56L40.52 30.56Q41.52 30.56 41.52 31.68L41.52 31.68Q41.32 33.88 35.20 37.60L35.20 37.60L35.20 38Q35.20 39.32 36.58 39.32Q37.96 39.32 39.56 38.40L39.56 38.40Q42.68 36.56 45.40 37.52L45.40 37.52Q47.24 38.16 47.48 37.96Q47.72 37.76 47.72 37.52L47.72 37.52Q47.72 37.16 47.16 36.20Q46.60 35.24 45.40 34.20ZM99.80 20.36L99.80 20.36Q101.56 18.04 102.28 17.56Q103 17.08 102.40 16.48L102.40 16.48Q101.44 15.52 100.80 15.52Q100.16 15.52 98.64 17.04L98.64 17.04Q96.32 19.32 94.60 21.08Q92.88 22.84 92.48 23.40L92.48 23.40Q91.80 24.28 91.80 24.68Q91.80 25.08 92.44 25.08L92.44 25.08Q94.72 25.08 99.80 20.36ZM90.28 27.56L90.28 27.56Q91.24 26.68 91.24 26.16Q91.24 25.64 90.04 26.04L90.04 26.04Q86.88 27.12 85.04 29.56L85.04 29.56Q84.36 30.52 84.88 30.52Q85.40 30.52 90.28 27.56ZM86.76 34.32L86.76 34.32Q88.20 33.12 88.20 32.52Q88.20 31.92 87.08 32.44L87.08 32.44Q86.20 32.84 85.32 33.72L85.32 33.72Q83.56 35.48 83.56 35.68Q83.56 35.88 84.16 35.88L84.16 35.88Q84.96 35.88 86.76 34.32ZM58 46.12L58 46.12Q59.88 45.40 60.16 45.12Q60.44 44.84 60.44 44.60L60.44 44.60Q60.44 44.20 59.80 43.20Q59.16 42.20 57.88 41.12L57.88 41.12Q55.96 39.44 54.40 38.80L54.40 38.80Q53.04 38.28 53.04 38.80Q53.04 39.00 53.64 39.84L53.64 39.84Q54.24 40.68 55.40 42.08L55.40 42.08Q57.16 44.32 58 46.12ZM73.72 40.52L73.72 40.52Q74.88 39.80 74.88 39.40Q74.88 39 74.08 39.12L74.08 39.12Q72.04 39.40 70.36 41.52L70.36 41.52Q69.24 43 69.24 43.16Q69.24 43.32 69.64 43.32L69.64 43.32Q70.52 43.32 73.72 40.52ZM79.64 38.64L79.64 38.64Q80.80 37.84 80.80 37.40Q80.80 36.96 79.92 37.08L79.92 37.08Q77.60 37.40 75.92 39.72L75.92 39.72Q75 41 75 41.16Q75 41.32 75.40 41.32L75.40 41.32Q76.24 41.32 79.64 38.64ZM66.44 43.16L66.44 43.16Q68.20 42.16 68.20 41.80Q68.20 41.44 66.84 41.68L66.84 41.68Q64.80 42 63.48 43.80L63.48 43.80Q62.76 44.76 62.76 44.88Q62.76 45 63.28 45L63.28 45Q63.92 45 66.44 43.16ZM55.68 31.84L55.68 31.84Q55.68 34.08 52.84 35.88Q50 37.68 47.28 37.68L47.28 37.68Q45.68 37.68 45.68 37.04Q45.68 36.88 46 36.60Q46.32 36.32 46.88 36.32L46.88 36.32Q50.28 36.32 52.56 34.20Q54.84 32.08 55.60 29.56L55.60 29.56Q55.68 29.56 55.68 30.08L55.68 31.84ZM62.92 34.08L62.92 34.08Q63.12 32.16 61.32 32.16L61.32 32.16Q60.52 32.16 59.96 32.68L59.96 32.68Q58.20 34.12 58.20 36.64L58.20 36.64Q58.20 38.16 58.96 38.16L58.96 38.16Q59.88 38.16 61.28 36.80L61.28 36.80Q62.68 35.44 62.92 34.08ZM66.84 37.96L66.84 37.96Q67.72 36.96 67.72 36.48Q67.72 36 67.04 36.16L67.04 36.16Q65.84 36.48 64.68 37.84L64.68 37.84Q63.52 39.20 63.52 39.44Q63.52 39.68 64.08 39.68L64.08 39.68Q64.88 39.68 66.84 37.96ZM73.16 34.64L73.16 34.64Q73.44 32.64 71.36 32.64L71.36 32.64Q70.16 32.64 69.44 33.36L69.44 33.36Q68.04 34.80 68.04 36.80L68.04 36.80Q68.04 37.60 68.56 37.60L68.56 37.60Q69.04 37.60 70.08 37.16L70.08 37.16Q72.76 36.16 73.16 34.64ZM79.60 34.88L79.60 34.88Q79.60 35.80 78.68 35.80L78.68 35.80Q78.36 35.80 77.88 35.60L77.88 35.60Q76.84 35.16 76.12 34.40L76.12 34.40Q74.96 33.24 74.96 31.56L74.96 31.56Q74.96 29.80 75.96 28.60L75.96 28.60Q76.96 27.40 78.44 27.40L78.44 27.40Q80.52 27.40 80.52 30.12L80.52 30.12Q80.52 32.28 78.72 34.32L78.72 34.32Q76.92 36.36 74.52 36.88L74.52 36.88Q74.04 37 73.96 37.04Q73.88 37.08 73.96 37.28Q74.04 37.48 74.32 37.48L74.32 37.48Q77.40 37.48 79.60 34.88ZM85.76 25.56L85.76 25.56Q85.76 26.56 84.88 27.68L84.88 27.68Q83.72 29.12 82.20 29.12L82.20 29.12Q81.56 29.12 81.16 28.72Q80.76 28.32 80.76 27.64L80.76 27.64Q80.76 26.24 81.68 25.12L81.68 25.12Q82.60 24 83.84 24L83.84 24Q84.80 24 85.28 24.60Q85.76 25.20 85.76 25.56ZM79.64 30.08L79.64 30.08Q79.64 28.48 78.48 28.48L78.48 28.48Q77.80 28.48 77.16 29.24L77.16 29.24Q76.24 30.32 76.24 31.60L76.24 31.60Q76.24 32.76 76.76 33.48L76.76 33.48Q77.28 34.20 77.88 34.20L77.88 34.20Q78.76 34.20 79.20 32.52L79.20 32.52Q79.64 30.84 79.64 30.08Z"
      fill="currentColor"
      fill-opacity="0"
      stroke="currentColor"
      stroke-width="0.3"
      stroke-linecap="round"
      stroke-linejoin="round"
      data-duration="2500"
      class="signature-path"
    />
  </svg>
</div>

<script define:vars={{ mode, drawDelay, rollbackDelay, loopPause, defaultDuration }}>
  function setupSignature(wrapper) {
    const paths = Array.from(wrapper.querySelectorAll('path'))
    if (paths.length === 0) return

    // 检查用户偏好
    const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)')
    if (motionQuery.matches) {
      paths.forEach((path) => {
        path.style.opacity = '1'
        path.style.fillOpacity = '1'
      })
      return
    }

    // 计算路径长度和动画时长
    const pathData = new Map()
    paths.forEach((path) => {
      const length = path.getTotalLength()
      const customDuration = path.getAttribute('data-duration')
      const duration = customDuration ? parseInt(customDuration, 10) : defaultDuration

      pathData.set(path, { length, duration })

      // 设置初始状态 - 完全隐藏 (描边长度偏移 + 透明度)
      path.style.strokeDasharray = `${length} ${length}`
      path.style.strokeDashoffset = length
      path.style.transition = 'none'
      path.style.opacity = '1'  // 容器可见
      path.style.fillOpacity = '0' // 填充透明
    })

    // 绘制动画 (描边 -> 填充)
    const drawSequentially = (index, callback) => {
      if (index >= paths.length) {
        if (callback) callback()
        return
      }

      const path = paths[index]
      const { duration } = pathData.get(path)
      const fillDuration = duration * 0.4 // 填充动画时长

      path.getBoundingClientRect() // 强制重排
      
      // 1. 描边动画
      path.style.transition = `stroke-dashoffset ${duration}ms ease-in-out, fill-opacity ${fillDuration}ms ease-in-out ${duration * 0.6}ms`
      path.style.strokeDashoffset = '0'
      // 2. 填充动画 (延迟触发，在描边快结束时开始填充)
      path.style.fillOpacity = '1'

      setTimeout(() => {
        const nextDelay = index < paths.length - 1 ? drawDelay : 0
        setTimeout(() => drawSequentially(index + 1, callback), nextDelay)
      }, duration)
    }

    // 回滚动画 (消失填充 -> 消失描边)
    const rollbackSequentially = (index, callback) => {
      if (index < 0) {
        if (callback) callback()
        return
      }

      const path = paths[index]
      const { length, duration } = pathData.get(path)
      const rollbackDuration = duration * 0.8
      const fillHideDuration = rollbackDuration * 0.3

      path.getBoundingClientRect() // 强制重排

      // 1. 填充消失 (快速)
      path.style.transition = `fill-opacity ${fillHideDuration}ms ease-out, stroke-dashoffset ${rollbackDuration}ms ease-in-out ${fillHideDuration}ms`
      path.style.fillOpacity = '0'
      
      // 2. 描边消失 (填充消失后)
      path.style.strokeDashoffset = length

      setTimeout(() => {
        const nextDelay = index > 0 ? rollbackDelay : 0
        setTimeout(() => rollbackSequentially(index - 1, callback), nextDelay)
      }, rollbackDuration + fillHideDuration)
    }

    // 执行动画
    if (mode === 'loop') {
      const runLoop = () => {
        drawSequentially(0, () => {
          setTimeout(() => {
            rollbackSequentially(paths.length - 1, () => {
              setTimeout(runLoop, loopPause / 2)
            })
          }, loopPause)
        })
      }
      setTimeout(runLoop, 500)
    } else {
      drawSequentially(0)
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.signature-wrapper').forEach(setupSignature)
    })
  } else {
    document.querySelectorAll('.signature-wrapper').forEach(setupSignature)
  }
</script>

<style>
  .signature-wrapper {
    display: block;
    width: 100%;
    margin-top: 3rem;
    padding: 1rem 0;
    clear: both;
    text-align: right;
  }

  .signature-svg {
    width: 200px;
    height: auto;
    display: inline-block;
  }

  .signature-path {
    /* 初始状态：透明，防止JS加载前的闪烁 */
    opacity: 0; 
  }

  @media (max-width: 768px) {
    .signature-svg {
      width: 150px;
    }
  }

  @media (max-width: 480px) {
    .signature-wrapper {
      text-align: center;
    }
    
    .signature-svg {
      width: 120px;
    }
  }

  @media print {
    .signature-wrapper {
      display: none;
    }
  }
</style>